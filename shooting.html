<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>子機シューティング</title>
<style>
  body { margin:0; background:black; overflow:hidden; }
  canvas { display:block; margin:0 auto; background:#111; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let gameOver = false, score = 0, level = 1;
const player = {x:canvas.width/2-15, y:canvas.height-50, width:30, height:30, speed:5, bullets:[], bulletPower:1, lives:3};
let enemies = [], enemyBullets = [], powerUps = [];
const keys = {};

document.addEventListener('keydown', e=>keys[e.key]=true);
document.addEventListener('keyup', e=>keys[e.key]=false);

let spawnTimer = 0, spawnInterval = 100;
let enemyDirection = 1, enemySpeedX = 0.5;

// 弾撃つ
function shoot(){ player.bullets.push({x:player.x+player.width/2-2.5*player.bulletPower, y:player.y, width:5*player.bulletPower, height:10, speedY:7}); }

// 衝突判定
function isColliding(a,b){ return a.x < b.x+b.width && a.x+a.width > b.x && a.y < b.y+b.height && a.y+a.height > b.y; }

// パワーアップ生成
function createPowerUp(x,y){ powerUps.push({x,y,width:20,height:20,speed:2}); }

// 子機出現
function spawnEnemy(){ 
    const w=30,h=30;
    const x=Math.random()*(canvas.width-w);
    const y=-h;
    enemies.push({x,y,width:w,height:h,alive:true});
}

// 更新
function update(){
    if(keys['ArrowLeft'] && player.x>0) player.x-=player.speed;
    if(keys['ArrowRight'] && player.x+player.width<canvas.width) player.x+=player.speed;
    if(keys[' ']) shoot();

    // 子機出現
    spawnTimer++;
    if(spawnTimer>=spawnInterval){ spawnTimer=0; spawnEnemy(); }

    // 自機弾
    player.bullets.forEach((b,i)=>{
        b.y-=b.speedY;
        if(b.y<0) player.bullets.splice(i,1);
        enemies.forEach((e,j)=>{
            if(e.alive && isColliding(b,e)){
                e.alive=false; player.bullets.splice(i,1); score+=10;
                if(Math.random()<0.3) createPowerUp(e.x,e.y);
            }
        });
    });

    // 敵弾
    enemyBullets.forEach((b,i)=>{
        b.y+=b.speedY; b.x+=b.speedX;
        if(b.y>canvas.height||b.x<0||b.x>canvas.width) enemyBullets.splice(i,1);
        if(isColliding(b,player)){ enemyBullets.splice(i,1); player.lives--; if(player.lives<=0) gameOver=true; }
    });

    // 敵接触
    enemies.forEach(e=>{ if(e.alive && isColliding(e,player)){ e.alive=false; player.lives--; if(player.lives<=0) gameOver=true; } });

    // パワーアップ取得
    powerUps.forEach((pu,i)=>{
        pu.y+=pu.speed;
        if(isColliding(player,pu)){ player.bulletPower++; if(player.lives<5) player.lives++; powerUps.splice(i,1); }
        else if(pu.y>canvas.height) powerUps.splice(i,1);
    });

    // 難易度上昇
    if(score>level*100){ level++; spawnInterval = Math.max(20, spawnInterval-5); }
}

// 敵移動＆弾発射
function moveEnemies(){
    enemies.forEach(e=>{
        if(e.alive){
            e.y+=0.5; // 下に少し進む
            e.x+=enemySpeedX*enemyDirection;
            if(e.x+e.width>=canvas.width-10||e.x<=10) enemyDirection*=-1;

            // 子機の弾発射
            if(Math.random()<0.01) enemyBullets.push({x:e.x+e.width/2-2.5,y:e.y+e.height,width:5,height:10,speedY:4,speedX:0});
        }
    });
}

// 背景スクロール
let bgY=0;
function drawBackground(){ bgY+=1; if(bgY>canvas.height) bgY=0; ctx.fillStyle='#111'; ctx.fillRect(0,bgY-600,canvas.width,canvas.height); ctx.fillRect(0,bgY,canvas.width,canvas.height); }

// 描画
function draw(){
    drawBackground();
    ctx.fillStyle='lime'; ctx.fillRect(player.x,player.y,player.width,player.height);
    ctx.fillStyle='yellow'; player.bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.width,b.height));
    ctx.fillStyle='red'; enemies.forEach(e=>{ if(e.alive) ctx.fillRect(e.x,e.y,e.width,e.height); });
    ctx.fillStyle='orange'; enemyBullets.forEach(b=>ctx.fillRect(b.x,b.y,b.width,b.height));
    ctx.fillStyle='cyan'; powerUps.forEach(pu=>ctx.fillRect(pu.x,pu.y,pu.width,pu.height));
    ctx.fillStyle='white'; ctx.font='20px Arial'; ctx.fillText('SCORE:'+score+'  LEVEL:'+level+'  LIVES:'+player.lives,10,25);
    if(gameOver){ ctx.fillStyle='white'; ctx.font='40px Arial'; ctx.fillText('GAME OVER',70,canvas.height/2); }
}

// ゲームループ
function gameLoop(){ if(!gameOver){ update(); moveEnemies(); draw(); requestAnimationFrame(gameLoop); } else draw(); }

gameLoop();
</script>
</body>
</html>
